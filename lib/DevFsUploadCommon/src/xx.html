<!DOCTYPE HTML>
<html lang='en'>

 <head>
  <meta charset='UTF-8'>
  <title>DevFsUploadESP v 2</title>
  <style>
   .none{display:none}
   .b{border-radius:15px;display:inline;}
   .foc{border:2px solid lightgray;}
   .brw{border:2px solid white;}
   .foc:focus,
   .brw:focus,
   .b:focus{border:2px solid blue;}
   .b2{color:red;}
   .b3{width:0px;height:18px;padding-right:15px;background:#f2fcf9;}

   .info{font-style:italic;font-size:0.8em;}
   .bof{direction:ltr;float:left;}
   .scrl{margin-left:24px;height:155px;overflow-y:scroll;direction:rtl;}

   .dtb{display:table;}
   .dtb .dro:nth-child(3n) div,
   .dtb .dro:nth-child(3n) div input{background:#ffffcc;}

   .sudo,
   .dtb .dro:nth-child(3n) div .sudo{font-style:italic;background:#8fd8d8;}

   .dro{display:table-row;}
   .dro div:nth-child(1) input{border:0px;}

   .dcl{display:table-cell;padding-right:10px;}
   .dnfrm{display:inline;}

   .siz{text-align:right;}
   .prjnam{color:#ff4500;text-decoration:underline;padding-bottom:10px;}
   #vuid{width:85ch;}
   #vuid p{margin-top:0;}

   .tab td:nth-child(2){text-align: right;}
  </style>
  <script>
   function gE(eId) {
     return document.getElementById(eId);
   }

   function upldbts() {
     var s = gE('dirroot').value;
     var isD = s.endsWith("/") && s.startsWith("/");
     var ufE = gE('upfileinp');
     var udE = gE('updirinp');
     var ufB = true, udB = true;
     var ufI = false, udI = false;
     if (ufE.value !== '' && isD) {
       ufB = false;
       udI = true;
     }
     if (udE.value !== '' && isD) {
       udB = false;
       ufI = true;
     }
     ufE.disabled = ufI;
     udE.disabled = udI;
     gE('upfilebtt').disabled = ufB;
     gE('updirbtt').disabled = udB;
   }

   function resetF(formid) {
     gE(formid).reset();
     upldbts();
   }
   function sortList(isF) {
     var tab = gE(isF ? 'lfiles' : 'ldirs');
     if (tab === null)
       return;
     var arr = [];
     while (tab.firstChild) {
       var a = tab.firstChild.innerHTML;
       if (a !== undefined)
         arr.push(a);
       tab.removeChild(tab.firstChild);
     }

     arr.sort();
     for (var i = 0; i < arr.length; i++) {
       var s = arr[i];
       var idx = s.lastIndexOf(' ');
       var nm = s.substring(0, idx);
       var len = nm.length + 2;
       var siz = s.substring(idx + 1);
       s = "<div class='dro'><div class='dcl'><input ";
       if (isF && nm.endsWith("/")
               || !isF && siz === "1") {
         s += "class='sudo' ";
       }
       s += "type='text' readonly tabindex='-1' value='" + nm + "'";
       if (isF) {
         s += " size = '" + len + "' > </div>\
   <div class='dcl siz'>" + siz + " </div><div class='dcl'>\
   <button class='b' onclick=\"ajaxFn('delete', this);\">Delete</button>\
    <button class='b' onclick=\"ajaxFn('view', this);\">View</button>";
         s += "<form class='dnfrm' method='post'>\
   <input type='hidden' name='fn' readonly value='" + nm + "'>\
    <button class='b' type='submit' name='down'>Download</button>\
    </form> < /div>";
       } else {
         s += " > <button class='b' name='seldir' onclick=\"setDf('" + nm + "');\">Select</button></div>";
         s += "<div class='dcl'>\
   <input class='foc' type='text' autocomplete='off' name='dnsub' value='' tabindex='0' oninput='mkval(this);'>\
   <button class='b' disabled onclick=\"ajaxMkdr(this); \">mk-subDir</button>\
   <button class='b b2' onclick=\"ajaxRmdir(this);\">rmDir</button>\
   </div>";
       }
       tab.insertAdjacentHTML('beforeend', s);
     }
   }
   function setDf(dn) {
     ajax('seldir', 'dn', dn);
     gE('dirroot').value = dn;
   }

   function inpE(thisE) {
     return thisE.parentNode.parentNode.childNodes[0].childNodes[0];
   }

   function ajaxFn(act, thisE) {
     ajax(act, 'fn', inpE(thisE).value);
   }

   function ajaxMkdr(thisE) {
     ajax('mksubdir',
             'dn', inpE(thisE).value,
             'dnsub', thisE.previousSibling.value);
   }
   function ajaxRmdir(thisE) {
     var dn = inpE(thisE).value;
     if (confirm(dn + "nnrmDir not reverse-able"))
       ajax('rmdir', 'dn', dn);
   }
   function mkval(ele) {
     var vE = ele.value;
     var ss = false;
     var em = "";
     if (vE.indexOf("/") !== -1) {
       em = "'/'";
       ss = true;
     } else if (vE.substring(0, 1) === " ") {
       ss = true;
       em = "lead space";
     }
     if (ss)
       alert(em + "  not permitted");
     if (vE === "")
       ss = true;
     ele.nextElementSibling.disabled = ss;
   }
   function oninpDir() {
     var upFld = gE('dirroot');
     upldbts();
     if (upFld.value.endsWith("/"))
       setDf(upFld.value);
   }

   function ajax(action, p1 = '', v1 = '', p2 = '', v2 = '') {
     var h = new XMLHttpRequest();
     var p = 'act';
     p += '=';
     p += action;
     if (p1 !== "") {
       p += '&';
       p += p1;
       p += '=';
       p += v1;
     }
     if (p2 !== "") {
       p += '&';
       p += p2;
       p += '=';
       p += v2;
     }

     h.open('POST', 'ajaxESP', true);
     h.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
     h.onreadystatechange = function () {
       if (this.readyState === 4 && this.status === 200) {

         if (this.responseText.startsWith('okay'))
           return;
         ['lastupldid', 'lflsid', 'ldrsid', 'vuid'].forEach(function (item, index) {
           gE(item).innerHTML = '';
         });
         var firstEq = this.responseText.indexOf("=");
         var act = this.responseText.substring(0, firstEq);
         var resp = this.responseText.substring(firstEq + 1).replace(/r|n/g, '');
         switch (act) {
           case 'onload':
             var arr = resp.split(',');
             gE('fstyid').innerHTML = arr[0];
             gE('dirroot').value = arr[1];
             if (arr[2] === 'yesupld') {
               ajax('upldlst');
             } else {
               gE('bdy').classList.remove('none');
             }
             return;
           case 'lfiles':
             gE('lflsid').innerHTML = resp;
             sortList(true);
             break;
           case 'ldirs':
             gE('ldrsid').innerHTML = resp;
             sortList(false);
             break;
           case 'upldlist':
             gE('lastupldid').innerHTML = resp;
             gE('bdy').classList.remove('none');
             break;
           case 'view':
             gE('vuid').innerHTML = resp;
             break;
         }
       }
     };
     h.send(p);
   }
  </script>
 </head>
 <body id='bdy' class='none' onload='ajax("onload");'>
  <table>
   <tr><td>1.</td>
    <td colspan='2' style='text-align:center'>
     upload dir: <input type='text' id='dirroot' class='foc' name='dirroot' oninput='oninpDir();' value='' size='32'><span class='info'> Select dir from 'List Dir...'</span></td></tr>

   <tr><td>2.</td><td><form method='post' id='upfile' enctype='multipart/form-data'>
      <button class='b b3' type='button' onclick='resetF("upfile");'>R</button>
      <input type='file' id='upfileinp' class='brw' name='name' multiple onchange='upldbts();'><br>
      <button class='b' id='upfilebtt' disabled>Upload file(s)</button> to dir</form></td>

    <td> <form method='post' id='updir' enctype='multipart/form-data'>
      <button class='b b3' type='button' onclick='resetF("updir");'>R</button>
      <input type='file' id='updirinp' class='brw' name='name' multiple webkitdirectory mozdirectory onchange='upldbts();' ><br>
      <button class='b' id='updirbtt' disabled>Upload Directory</button> all files: browse-dir + sub-dir(s)
     </form></td></tr>

   <tr><td></td><td colspan='2' class='info'>1-20 files ideal to prevent memory issues in upload execution on device.</td></tr></table>
  <div id='lastupldid'></div>


  <table><tr><td>
     <button class='b' onclick="ajax('list', 'files', 'do');">List Files</button>
     <button class='b' onclick="ajax('list', 'dirs', 'do');">List Dir(s)</button></td>
    <td class='prjnam'> DevFsUploadESP - <span id='fstyid'></span></td></tr></table>

  <div id='lflsid'></div>
  <div id='ldrsid'></div>
  <table><tr><td><div id='vuid'></div></td></tr></table>

 </body></html>